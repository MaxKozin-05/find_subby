<!-- app/views/quotes/show.html.erb -->
<div class="max-w-5xl mx-auto p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <%= link_to quotes_path, class: "text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1 mb-2" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Quotes
      <% end %>
      <h1 class="text-2xl font-semibold text-gray-900"><%= @quote.title %></h1>
      <p class="text-gray-600 mt-1">Version <%= @quote.version %> â€¢ Created <%= @quote.created_at.strftime("%B %d, %Y") %></p>
    </div>

    <div class="flex items-center gap-3">
      <span class="px-4 py-2 text-sm font-medium rounded-full
        <%= case @quote.status
            when 'draft' then 'bg-gray-100 text-gray-800'
            when 'sent' then 'bg-blue-100 text-blue-800'
            when 'accepted' then 'bg-green-100 text-green-800'
            when 'expired' then 'bg-red-100 text-red-800'
            end %>">
        <%= @quote.status.humanize %>
      </span>

      <!-- Action Buttons -->
      <div class="flex gap-2">
        <%= link_to edit_quote_path(@quote),
            class: "px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50" do %>
          Edit
        <% end %>

        <%= link_to duplicate_quote_path(@quote), method: :post,
            class: "px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50" do %>
          Duplicate
        <% end %>

        <% if @quote.pdf_file.attached? %>
          <%= link_to pdf_quote_path(@quote), target: "_blank",
              class: "px-4 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700" do %>
            View PDF
          <% end %>
        <% else %>
          <%= link_to generate_pdf_quote_path(@quote), method: :patch,
              class: "px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700" do %>
            Generate PDF
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-3">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Quote Information -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Quote Information</h2>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <h3 class="font-medium text-gray-900 mb-1">Pricing Model</h3>
            <p class="text-gray-700"><%= @quote.pricing_model.humanize %></p>
          </div>

          <% if @quote.job %>
            <div>
              <h3 class="font-medium text-gray-900 mb-1">Related Job</h3>
              <p class="text-gray-700">
                <%= link_to @quote.job.title, @quote.job, class: "text-blue-600 hover:text-blue-700" %>
              </p>
            </div>
          <% end %>
        </div>

        <% if @quote.description.present? %>
          <div class="mt-4">
            <h3 class="font-medium text-gray-900 mb-2">Description</h3>
            <div class="text-gray-700 whitespace-pre-wrap"><%= simple_format(@quote.description) %></div>
          </div>
        <% end %>
      </div>

      <!-- Labour Items -->
      <% labour_items = @quote.quote_items.labour %>
      <% if labour_items.any? %>
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-blue-700">Labour</h2>
          </div>
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="min-w-full">
                <thead>
                  <tr class="text-left text-sm font-medium text-gray-500">
                    <th class="pb-3">Description</th>
                    <th class="pb-3">Quantity</th>
                    <th class="pb-3">Unit</th>
                    <th class="pb-3">Unit Price</th>
                    <th class="pb-3 text-right">Line Total</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <% labour_items.each do |item| %>
                    <tr>
                      <td class="py-3 text-sm text-gray-900"><%= item.description %></td>
                      <td class="py-3 text-sm text-gray-700"><%= number_with_precision(item.quantity, precision: 2, strip_insignificant_zeros: true) %></td>
                      <td class="py-3 text-sm text-gray-700"><%= item.unit %></td>
                      <td class="py-3 text-sm text-gray-700"><%= number_to_currency(item.unit_price) %></td>
                      <td class="py-3 text-sm text-gray-900 text-right font-medium"><%= number_to_currency(item.line_total) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex justify-between text-sm font-medium">
                <span>Labour Subtotal:</span>
                <span><%= number_to_currency(labour_items.sum(&:line_total)) %></span>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Materials Items -->
      <% materials_items = @quote.quote_items.materials %>
      <% if materials_items.any? %>
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-green-700">Materials</h2>
          </div>
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="min-w-full">
                <thead>
                  <tr class="text-left text-sm font-medium text-gray-500">
                    <th class="pb-3">Description</th>
                    <th class="pb-3">Quantity</th>
                    <th class="pb-3">Unit</th>
                    <th class="pb-3">Unit Price</th>
                    <th class="pb-3 text-right">Line Total</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <% materials_items.each do |item| %>
                    <tr>
                      <td class="py-3 text-sm text-gray-900"><%= item.description %></td>
                      <td class="py-3 text-sm text-gray-700"><%= number_with_precision(item.quantity, precision: 2, strip_insignificant_zeros: true) %></td>
                      <td class="py-3 text-sm text-gray-700"><%= item.unit %></td>
                      <td class="py-3 text-sm text-gray-700"><%= number_to_currency(item.unit_price) %></td>
                      <td class="py-3 text-sm text-gray-900 text-right font-medium"><%= number_to_currency(item.line_total) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex justify-between text-sm font-medium">
                <span>Materials Subtotal:</span>
                <span><%= number_to_currency(materials_items.sum(&:line_total)) %></span>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Quote Summary -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Quote Summary</h2>

        <div class="space-y-3">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Subtotal:</span>
            <span class="font-medium"><%= number_to_currency(@quote.subtotal) %></span>
          </div>

          <% if @quote.gst_enabled? %>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">GST (<%= number_to_percentage(@quote.gst_rate * 100, precision: 1) %>):</span>
              <span class="font-medium"><%= number_to_currency(@quote.gst_amount) %></span>
            </div>
          <% end %>

          <div class="flex justify-between text-lg font-semibold border-t pt-3">
            <span>Total:</span>
            <span class="text-blue-600"><%= number_to_currency(@quote.total) %></span>
          </div>
        </div>
      </div>

      <!-- Version History -->
      <% if @quote.parent_quote || @quote.child_quotes.any? %>
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-lg font-semibold mb-4">Version History</h2>

          <div class="space-y-2">
            <% root_quote = @quote.parent_quote || @quote %>
            <% all_versions = [root_quote, *root_quote.child_quotes].sort_by(&:version) %>

            <% all_versions.each do |version| %>
              <div class="flex items-center justify-between py-2 px-3 rounded <%= version.id == @quote.id ? 'bg-blue-50 border border-blue-200' : 'hover:bg-gray-50' %>">
                <div>
                  <span class="font-medium text-sm">Version <%= version.version %></span>
                  <% if version.id == @quote.id %>
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      Current
                    </span>
                  <% end %>
                  <div class="text-xs text-gray-500"><%= version.created_at.strftime("%b %d, %Y") %></div>
                </div>
                <% unless version.id == @quote.id %>
                  <%= link_to "View", version, class: "text-sm text-blue-600 hover:text-blue-700" %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Actions</h2>

        <div class="space-y-3">
          <%= link_to edit_quote_path(@quote),
              class: "w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit Quote
          <% end %>

          <%= link_to duplicate_quote_path(@quote), method: :post,
              class: "w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Create New Version
          <% end %>

          <% unless @quote.pdf_file.attached? %>
            <%= link_to generate_pdf_quote_path(@quote), method: :patch,
                class: "w-full inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm text-sm font-medium hover:bg-blue-700" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Generate PDF
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
