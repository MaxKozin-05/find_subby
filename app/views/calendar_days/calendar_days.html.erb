<!-- app/views/calendar_days/index.html.erb -->
<div class="max-w-6xl mx-auto p-6" data-controller="calendar"
     data-calendar-year-value="<%= @year %>"
     data-calendar-month-value="<%= @month %>">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold">Availability Calendar</h1>

    <!-- Month Navigation -->
    <div class="flex items-center gap-4">
      <%= link_to calendar_days_path(year: @current_date.prev_month.year, month: @current_date.prev_month.month),
          class: "p-2 text-gray-600 hover:text-gray-900" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      <% end %>

      <h2 class="text-lg font-medium min-w-[200px] text-center">
        <%= @current_date.strftime("%B %Y") %>
      </h2>

      <%= link_to calendar_days_path(year: @current_date.next_month.year, month: @current_date.next_month.month),
          class: "p-2 text-gray-600 hover:text-gray-900" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      <% end %>
    </div>
  </div>

  <!-- Legend -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <h3 class="font-medium mb-3">Legend</h3>
    <div class="flex flex-wrap gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-green-100 border border-green-200 rounded"></div>
        <span>Available</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-red-100 border border-red-200 rounded"></div>
        <span>Busy</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-blue-100 border border-blue-200 rounded"></div>
        <span>Booked (Job Scheduled)</span>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <h3 class="font-medium mb-3">Quick Actions</h3>
    <div class="flex flex-wrap gap-2">
      <button data-action="click->calendar#markWeekend"
              class="px-3 py-1 text-sm bg-red-100 text-red-800 rounded hover:bg-red-200">
        Mark Weekends Busy
      </button>
      <button data-action="click->calendar#clearWeekend"
              class="px-3 py-1 text-sm bg-green-100 text-green-800 rounded hover:bg-green-200">
        Clear Weekends
      </button>
      <button data-action="click->calendar#markWeekAvailable"
              class="px-3 py-1 text-sm bg-green-100 text-green-800 rounded hover:bg-green-200">
        Mark This Week Available
      </button>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <!-- Day Headers -->
    <div class="grid grid-cols-7 bg-gray-50 border-b">
      <% %w[Sunday Monday Tuesday Wednesday Thursday Friday Saturday].each do |day| %>
        <div class="p-3 text-center text-sm font-medium text-gray-700 border-r last:border-r-0">
          <%= day %>
        </div>
      <% end %>
    </div>

    <!-- Calendar Days -->
    <div class="grid grid-cols-7">
      <% calendar_start = @current_date.beginning_of_month.beginning_of_week %>
      <% calendar_end = @current_date.end_of_month.end_of_week %>

      <% (calendar_start..calendar_end).each do |date| %>
        <%
          is_current_month = date.month == @month
          is_today = date == Date.current
          calendar_entry = @calendar_data[date]
          state = calendar_entry&.dig(:state) || 'available'
          source = calendar_entry&.dig(:source) || 'default'
          notes = calendar_entry&.dig(:notes)
        %>

        <div class="min-h-[80px] p-2 border-r border-b last-in-row:border-r-0 last-row:border-b-0
                    <%= 'bg-gray-50' unless is_current_month %>
                    <%= 'ring-2 ring-blue-500' if is_today %>"
             data-calendar-target="day"
             data-date="<%= date.iso8601 %>"
             data-state="<%= state %>"
             data-source="<%= source %>"
             data-action="click->calendar#toggleDay">

          <!-- Date Number -->
          <div class="flex items-start justify-between mb-1">
            <span class="text-sm font-medium
                        <%= is_current_month ? 'text-gray-900' : 'text-gray-400' %>
                        <%= 'text-blue-600 font-bold' if is_today %>">
              <%= date.day %>
            </span>

            <% if is_current_month %>
              <!-- State Indicator -->
              <div class="w-3 h-3 rounded-full
                          <%= case state
                              when 'available' then 'bg-green-400'
                              when 'busy' then 'bg-red-400'
                              when 'booked' then 'bg-blue-400'
                              end %>">
              </div>
            <% end %>
          </div>

          <% if is_current_month %>
            <!-- State Badge -->
            <div class="text-xs px-2 py-1 rounded-full text-center
                        <%= case state
                            when 'available' then 'bg-green-100 text-green-800'
                            when 'busy' then 'bg-red-100 text-red-800'
                            when 'booked' then 'bg-blue-100 text-blue-800'
                            end %>">
              <%= state.humanize %>
            </div>

            <!-- Notes -->
            <% if notes.present? %>
              <div class="text-xs text-gray-600 mt-1 truncate" title="<%= notes %>">
                <%= notes %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Mobile View Instructions -->
  <div class="mt-4 text-sm text-gray-600 md:hidden">
    <p>Tap any date to toggle between Available and Busy.</p>
  </div>

  <!-- Desktop View Instructions -->
  <div class="mt-4 text-sm text-gray-600 hidden md:block">
    <p>Click any date to toggle between Available and Busy. Use quick actions above for faster bulk changes.</p>
  </div>
</div>
